# MG / SKiDIY / 症狀→練習 SDD v0（簡版）
**日期**：2025-10-25  
**Owner**：James（SKiDIY）  
**狀態**：草案（1-pager）

## 規格模型來源
此規格模型根據 [`Formulation.md`](../prompt/Formulation.md) 中的規則從原始需求描述中萃取並結構化而成，包含：
- **資料模型**：以 DBML 格式描述實體關係模型 (ERM) 於 `spec/erm.dbml`
- **功能模型**：以 Gherkin Language 風格描述功能規則於 `spec/features/*.feature`

---

## 1. 概覽（Overview）
**目標**：使用者以**口語問題**描述滑行困擾；系統經**最少追問（0–2 題）**，輸出**3–5 個文字版練習卡**。  
**對象**：學員、教練皆可（誰提問都能拿到可執行答案）。  
**範圍（MVP）**：等級、地形、滑行風格皆為**可擴充列表**；輸出**文字為主**。  
**方法**：問題引導＋上下文蒐集 → **RAG** 從**教練答覆＋影片逐字稿**抽取原理與步驟 → 提示詞優化 → **LLM 生成練習卡內容**（前台**不顯示引用**）。未來 AI 可直接參與選卡片。  
**非目標**：圖/影片生成、電腦視覺姿態分析、完整進度追蹤、公開分享權限。

---

## 3. 功能需求（FR，最小集合）
1) **輸入**：自由文字（繁中）；可選填 Slot：等級、地形、滑行風格（皆為可擴充列表）。  
2) **自適應追問**：若症狀/條件置信度不足（綜合考量模型機率、多個相近症狀、口語簡短模糊、缺少 Slot 資訊）→最多追問 2 題；否則零追問。追問問題來源結合通用問題庫與根據缺失 Slot 資訊動態生成。  
3) **症狀辨識**：口語→標準化「症狀種子」（多對一關係）；同義歸一（同義詞庫動態擴充）；納入裝備設定相關症狀辨識。若置信度不足，系統應向使用者確認辨識結果。  
4) **建議生成**：對應「練習卡」集合（3–5 張），選擇標準結合關聯性分數與使用者條件動態組合，依關聯性分數高低排序。處理數量邊界條件（不足 3 張回傳所有符合的，超過 5 張選取前 5 張）。  
5) **回饋**：👍/👎 評分；收集自由文字回饋（內部優化）。

---

## 4. 非功能需求（NFR）
- **回應時間**：
    - P95 < 2.5s（雲端條件下）。
    - P99 < 5s（雲端條件下）。
    - 練習卡生成時間 < 1s。
- **可靠性**：
    - 無法辨識時回傳「最安全基礎練習組」。
    - 系統可用性 (Availability) > 99.9% (每年停機時間少於 8.76 小時)。
    - 錯誤恢復：系統應能從常見錯誤中自動恢復，並記錄錯誤日誌。
- **語言**：
    - UI 繁中；內部可保留雙語標籤（選做）。
    - 未來可擴展至多語言支援。
- **安全性**：
    - 確保資料輸入安全，防止 SQL/NoSQL 注入、XSS 攻擊。
    - 保護使用者隱私，所有敏感資料應加密儲存和傳輸。
    - 實施 API 速率限制，防止惡意攻擊。
    - 金鑰管理：API 金鑰和憑證應安全儲存和輪換。
    - 身份驗證與授權：所有管理介面應具備強身份驗證和基於角色的授權機制。
- **可擴展性**：
    - 架構設計需考慮未來從輕量化方案擴展到更複雜系統的需求。
    - 支援至少 1000 併發使用者。
    - 支援資料量每年增長 50%。
- **AI 安全**：
    - 防範提示詞注入 (Prompt Injection)，實施輸入驗證和過濾。
    - 實施內容過濾，避免生成不當或有害內容。
    - 保護模型免受惡意使用和資料洩露。
- **測試覆蓋率**：
    - 確保核心功能有充分的測試覆蓋，目標程式碼覆蓋率 > 80%。
    - 關鍵業務流程應有端到端測試。
- **品質保證**：
    - 透過自動化測試確保軟體品質和功能正確性。
    - 實施持續整合/持續部署 (CI/CD) 流程。
- **彈性設計**：
    - 實施工熔斷器模式、重試機制和降級策略，確保系統在部分服務失效時仍能提供基本功能。
    - 服務應具備自我修復能力。
- **錯誤處理**：
    - 實施全面的錯誤恢復和監控告警機制。
    - 錯誤訊息應清晰、具體，便於開發人員排查問題。
    - 對使用者顯示友善的錯誤提示。
- **使用者體驗**：
    - 提供直覺的介面設計、智慧提示功能和回應式設計，確保易用性。
    - 介面載入時間 P95 < 2s。
    - 減少使用者操作步驟。
- **效能優化**：
    - 實施快取機制（例如 Redis）減少資料庫負載。
    - 採用非同步處理，優化回應時間。
    - 資料庫查詢應優化，避免 N+1 問題。
- **維護性**：
    - 實施自動化測試與部署，確保系統長期穩定運行。
    - 程式碼應遵循一致的編碼規範和風格。
    - 提供清晰的開發者文件。
- **可監控性**：
    - 提供系統指標監控（CPU, Memory, Network, Disk I/O）。
    - 記錄應用程式日誌和錯誤日誌。
    - 實施使用者行為分析，支持持續改進和功能優化。

---

## 5. 互動流程（Flow）
1) 使用者輸入口語問題及選填資訊 → 2) 系統進行症狀辨識 → 3) （必要時）系統判斷置信度不足並追問 0–2 題 → 4) 系統生成並回傳 3–5 張練習卡 → 5) 使用者評價。

---

## 6. 來源與知識（Source & RAG）
- **來源**：教練文字答覆、影片逐字稿（僅初～中級相關）。  
- **RAG 架構與工作流程**：
    -   **知識庫建立**：
        -   對知識來源（教練答覆、影片逐字稿）進行預處理（清洗、分段、結構化）。
        -   將處理後的知識（例如：症狀描述、練習步驟、原理說明）儲存於向量資料庫 (Vector Database) 或可檢索的索引中。
        -   **範例**：
            -   **教練答覆**：「轉彎會後坐是因為重心太後，可以嘗試外腳多施壓。」
            -   **抽取知識**：症狀：「轉彎會後坐」；原因：「重心太後」；練習建議：「外腳多施壓」。
    -   **檢索機制 (Retrieval)**：
        -   當使用者輸入問題時，系統會從知識庫中檢索出與問題最相關的知識片段。
        -   **與 LLM 協同**：檢索結果會作為 LLM 的上下文資訊。
    -   **生成機制 (Generation)**：
        -   將檢索出的知識片段與使用者問題結合，形成優化後的提示詞 (Prompt)。
        -   將優化後的提示詞發送給大型語言模型 (LLM)。
        -   LLM 根據提示詞生成練習卡的 `goal`, `tips`, `pitfalls`, `dosage`, `self_check` 等內容。
- **RAG 與核心功能的關係**：
    -   **影響症狀辨識**：RAG 檢索出的知識可以提供更豐富的上下文，輔助 LLM 更精準地理解使用者問題，從而提高症狀辨識的準確性。例如，如果 RAG 檢索到「重心太後」與「轉彎會後坐」的強關聯，將有助於系統將口語問題標準化。
    -   **輔助練習卡選擇與排序**：RAG 提供的知識片段（例如練習的原理、適用情境）可以作為計算練習卡「關聯性分數」的依據，或輔助 LLM 在多個練習卡中做出更合理的選擇和排序。
- **抽取**：分離**症狀句**與**建議句**；聚類同義，產生 Top 15 候選 → 人工複審成 **8–10 條症狀種子**。  
- **排序權重**：**頻率 0.6** ＋ **可行度 0.3** − **歧義 0.1**（內部可調）。

---

## 7. 資料模型 (Data Model)

資料模型已根據 [`Formulation.md`](../prompt/Formulation.md) 中的規則從原始需求描述中萃取並結構化為實體關係模型 (ERM)，詳細定義請參見 [`spec/erm.dbml`](./spec/erm.dbml)：

- **Symptom**：症狀實體，包含症狀的基本資訊、同義詞、適用範圍等
- **PracticeCard**：練習卡實體，包含練習卡的詳細內容、目標、建議等
- **Session**：會話實體，記錄使用者與系統的互動過程
- **SymptomPracticeMapping**：症狀與練習卡的關聯表，實現多對多關係

### 關係說明
- **Symptom** 和 **PracticeCard** 之間為多對多關係，透過 **SymptomPracticeMapping** 關聯表實現
- **Session** 記錄使用者與系統的互動，關聯至辨識出的 **Symptom**

---



## 8. 系統架構與技術選型
- **後端框架**：Python + FastAPI
    - 理由：高效能、自動 API 文件、型別檢查支援
- **前端框架**：React + TypeScript
    - 理由：豐富生態系、元件化架構、TypeScript 支援
- **資料庫**：SQLite (開發階段) / Supabase (部署階段)
    - 理由：輕量、無需額外伺服器、易於部署 (開發階段)；完整功能支援 (部署階段)
- **ORM**：SQLAlchemy
    - 理由：支援多種資料庫，易於未來遷移
- **向量資料庫**：ChromaDB
    - 理由：輕量化、易於整合、支援 Python
- **AI/LLM**：Sentence Transformers + Hugging Face Models
    - 理由：開源、支援本地化部署
- **部署方案**：Vercel (前端) + Vercel Functions (後端) + Supabase (資料庫)
    - 理由：無伺服器架構、自動擴展、易於維護

### 8.1 擴展架構
為確保未來可擴展性，採用六邊形架構（端口與適配器模式）：
- 業務邏輯與技術實現分離
- 預留技術組件替換接口
- 使用抽象層設計，便於未來遷移

### 8.2 實現層簡化原則
遵循 Linus Torvalds 的"好品味"原則：
- **消除不必要的複雜度**：移除多代理架構，使用簡單函數實現核心邏輯
- **保持實現簡單直接**：使用字典結構而非複雜 Pydantic 模型，簡化數據處理流程
- **專注於解決核心問題而非架構問題**：保持 RAG 架構但簡化實現層，專注於語義理解和知識檢索
- **確保向後兼容性**：保持 API 接口和數據格式不變，僅簡化內部實現

### 8.3 簡化架構實現
根據 [`docs/architecture-simplified.md`](./docs/architecture-simplified.md) 中的簡化架構設計：
- **服務層簡化**：使用簡單函數而非複雜代理模式實現核心邏輯
- **數據模型簡化**：使用字典結構而非複雜物件導向設計
- **API 層簡化**：簡化路由處理邏輯但保持接口不變
- **保持核心功能**：RAG 架構、AI 語義理解、知識檢索等功能保持不變

---


## 9. 練習卡（輸出格式 v0）
- **名稱｜目標｜要點（最多 3 項）｜常見錯誤修正（單一文字）｜建議次數/時長（自由文字）｜適用（等級/地形/風格）｜自我檢查（最多 3 項）**  
> 例：*J 型轉彎（延後換刃）｜完成外腳承重再過中立｜視線外緣；外腳 70–80%；中立後換刃｜避免提前壓內腳｜藍線 6 次/趟 ×3 趟｜初～中｜是否在換刃前感到外腳壓力峰值？*

**備註**：練習卡的輸出格式可能因 `card_type` 而異，UI 需具備彈性。

---

## 10. 評估指標（Metrics）
- **Helpful Rate**（👍比率）  
- **平均追問數**（≤ 1.0 為佳）  
- **Coverage**（成功映射比例）

---

## 11. 風險與緩解（Risks）
- 症狀歧義 → 以「安全基礎練習組」回退＋逐步擴充種子。若置信度不足，系統應向使用者確認辨識結果。
- 語言多樣 → 持續擴充同義詞庫與聚類規則（同義詞庫動態擴充）。
- 來源品質參差 → 人工複審 Top 15 → v0 種子 8–10 條。
- **擴展風險** → 採用六邊形架構設計，確保未來可遷移到更複雜的系統。
---

## 12. 里程碑（Milestones，2–3 週滾動）
- **M0**：蒐集來源→Top 15 候選→種子 8–10。  
- **M1**：完成文字版生成與追問規則；上線小測。  
- **M2**：收集回饋與擴充映射；考慮加入圖示意（選做）。


