# TurnFix 規劃釐清總結 (2025-10-28)

本文檔記錄了 TurnFix MVP 實作計劃的最終釐清結果，涵蓋 UI 頁面對應、RAG 資料處理、自適應追問邏輯、以及練習卡數量處理的具體策略。

---

## 1. UI 頁面規劃（對應實際設計稿）

根據 `/UI` 資料夾中的設計稿，補充了詳細的 UI 實作任務對應：

### 核心頁面結構

| 頁面 | UI 任務 ID | 主要功能 | 對應設計稿 |
|------|-----------|--------|----------|
| 首頁 (Dashboard) | UI-300 | 歡迎信息、最近會話、快速操作 | 首頁/screen.png |
| 我的問題 | UI-301 | 輸入問題、選填等級/地形/風格 | 我的問題_(my_issues)/code.html |
| 自適應追問 | UI-302 | 顯示 1-2 個追問問題 | (內嵌在輸入流程中) |
| 練習卡建議列表 | UI-303 | 展示系統推薦的 3-5 張練習卡 | 我的練習_-_系統建議/code.html |
| 練習卡詳細頁 | UI-304 | 完整展示卡片內容、進度追蹤、回饋 | 單板滑雪練習卡/code.html |
| 練習歷史 | UI-305 | 過往會話記錄、可搜尋和篩選 | 我的練習_-_歷史記錄/code.html |
| 設定 | UI-306 | 使用者偏好、應用程式設定 | 設定/code.html |
| 使用者回饋 | UI-307 | 👍/👎 評分 + 文字回饋 | (內嵌在卡片詳細頁) |
| 管理者後台 | UI-308 | 症狀/練習卡/關聯/同義詞 CRUD | (新建頁面) |

### 頁面導航流程

```
首頁 (UI-300)
├── 我的問題 (UI-301)
│   ├── [自適應追問] (UI-302)
│   └── → 練習卡建議列表 (UI-303)
│       └── 練習卡詳細頁 (UI-304)
│           ├── 使用者回饋 (UI-307)
│           └── → 首頁 or 我的練習
├── 我的練習
│   ├── 系統建議 (UI-303)
│   ├── 歷史記錄 (UI-305)
│   └── [單個練習卡詳細] (UI-304)
├── 設定 (UI-306)
└── [管理者] 後台 (UI-308)
```

---

## 2. RAG 資料處理管道 & 清洗工具架構

確認已有教練答覆和影片逐字稿資料（.txt/.md 格式），需要建立詳細的預處理和提取流程。

### 資料清洗工具定位

**資料清洗工具是獨立於 TurnFix 應用的輔助系統**，用於：
1. **一次性清洗**：將現有的 .txt/.md 逐字稿清洗成結構化格式
2. **定期維護**：當有新教練答覆或影片時，運行清洗工具更新知識庫
3. **品質控制**：提供人工審核 UI，確保抽取的症狀/練習建議準確

**組織位置**：
```
TurnFix/
├── backend/          # 主應用
│   ├── api/
│   ├── services/
│   ├── models/
│   └── ...
├── tools/            # 獨立工具集（新增）
│   └── data_preparation/
│       ├── scripts/
│       │   ├── clean_transcripts.py      # 清洗 .txt/.md 逐字稿
│       │   ├── extract_knowledge.py      # 自動抽取症狀、練習建議
│       │   ├── validate_data.py          # 驗證資料品質
│       │   └── import_to_chroma.py       # 導入到 ChromaDB
│       ├── cli.py                        # CLI 入口點
│       ├── data_in/                      # 輸入資料夾（原始逐字稿）
│       ├── data_out/                     # 輸出資料夾（清洗後的 JSON）
│       └── README.md                     # 使用說明
├── frontend/         # 主應用前端
└── docs/
```

### 資料流向

```
原始資料 (教練答覆、影片逐字稿)
    ↓
清洗 (RAG-251.1, RAG-251.2)
    ↓
結構化抽取 (DM-250.1, DM-250.2)
    ├── 症狀描述抽取
    └── 練習建議抽取
    ↓
知識庫建立 (RAG-252)
    ├── ChromaDB 存儲
    └── 向量化 (Sentence Transformers)
    ↓
檢索機制 (RAG-253)
    ├── 向量相似度搜尋
    └── 混合搜尋 (向量 + 關鍵詞)
    ↓
提示詞組裝 (RAG-254)
    ↓
LLM 生成 (RAG-255)
    ├── 症狀辨識輔助
    ├── 練習卡生成
    └── 追問建議生成
```

### 具體任務清單

**RAG-251: 資料清洗**
- RAG-251.1：教練答覆清洗（移除格式符號、日期正規化、單位標準化）
- RAG-251.2：影片逐字稿清洗（移除時間戳、合併斷句、語言檢測）
- RAG-251.3：文本分段（基於句子或段落，保留上下文）

**DM-250: 結構化抽取**
- DM-250.1：症狀抽取腳本（識別症狀關鍵詞和描述）
- DM-250.2：練習建議抽取腳本（識別動作要點、常見錯誤、建議次數）
- DM-250.3：結構化知識表示（症狀 → 原因 → 練習方案）
- DM-250.4：人工審核機制（待審核標記、管理者確認）

**RAG-252: 向量資料庫**
- RAG-252.1：ChromaDB 持久化配置
- RAG-252.2：知識片段存儲結構（text、metadata、source、timestamps）
- RAG-252.3：知識導入腳本

**RAG-253: 檢索機制**
- RAG-253.1：Sentence Transformers 向量化（多語言 MiniLM）
- RAG-253.2：相似度搜尋（返回 Top-K）
- RAG-253.3：混合搜尋機制（向量相似度 + 關鍵詞匹配）

**RAG-254: 提示詞組裝**
- RAG-254.1：提示詞模板設計（症狀辨識、練習卡生成、追問邏輯）
- RAG-254.2：上下文組裝邏輯
- RAG-254.3：提示詞優化（長度控制、優先級）

**RAG-255: LLM 整合**
- RAG-255.1：LLM API 配置（OpenAI/Hugging Face/本地模型）
- RAG-255.2：練習卡內容生成
- RAG-255.3：症狀辨識輔助
- RAG-255.4：追問建議生成

---

### 資料清洗工具的執行流程

```
1. 清洗 (TOOL-101)
   .txt/.md 逐字稿 → 移除雜訊、分段 → cleaned_*.json

2. 抽取 (TOOL-102)
   cleaned_*.json → NLP/Regex → candidates_*.json（待審核）

3. 驗證 (TOOL-103)
   candidates_*.json → 檢查品質 → validation_report.txt

4a. 審核（本地 Web UI）(TOOL-104)
    candidates_*.json → [人工修改] → approved_*.json

4b. 審核（應用 API）(TOOL-107)
    candidates_*.json → [應用管理後台審核] → approved_*.json

5. 導入 (TOOL-105)
   approved_*.json → 向量化 + 入 ChromaDB → 完成
```

### 工具使用範例

**場景 1：初次處理現有逐字稿**
```bash
# 1. 清洗逐字稿
python cli.py clean --input ./data_in --output ./data_out

# 2. 自動抽取知識
python cli.py extract --input ./data_out --review-mode

# 3. 打開 Web 介面進行人工審核
# http://localhost:8000 (自動啟動)

# 4. 驗證結果
python cli.py validate --input ./data_out

# 5. 導入到 ChromaDB
python cli.py import --input ./data_out --chroma-db-path ../backend/chroma_db
```

**場景 2：定期更新新教練答覆**
```bash
# 將新的逐字稿放入 data_in/
# 然後直接運行（推薦自動化）
python cli.py clean --input ./data_in --output ./data_out
python cli.py extract --input ./data_out
python cli.py import --input ./data_out --chroma-db-path ../backend/chroma_db
```

**場景 3：應用內部審核流程**
```
用戶在應用管理後台：
「知識庫管理」→ 上傳待審核檔案 → API-TOOL-107.1 接收
→ 查看列表 → API-TOOL-107.2
→ 修改/批准/拒絕 → API-TOOL-107.3
→ 導出並執行 TOOL-105 導入
```

---

## 3. 自適應追問邏輯設計

**設計原則**：使用 **LLM 輔助判斷** 代替硬編碼規則，提升系統彈性。

### API-203 實作細節

#### API-203.1: LLM 輔助置信度判斷

**輸入 Context**（傳給 LLM）：
```json
{
  "user_input": "轉彎會後坐",
  "detected_symptoms": [
    { "symptom": "後坐", "confidence": 0.85, "source": "LLM" },
    { "symptom": "重心不穩", "confidence": 0.62, "source": "keyword_match" }
  ],
  "slots": {
    "level": null,  // 缺失
    "terrain": "藍線",
    "style": null   // 缺失
  },
  "input_length": 8,  // 字數
  "timestamp": "2025-10-28T14:30:00Z"
}
```

**LLM 判斷邏輯**：
- 症狀置信度 < 0.7 → 判斷需要澄清
- 多個症狀競爭（如 0.85 vs 0.62）→ 判斷需要澄清
- 缺少關鍵 Slot（等級、地形）→ 判斷需要追問
- 使用者描述過短（< 10 字）→ 判斷需要追問
- 綜合上述因素，決定是否追問及追問數量（0-2 題）

**LLM Prompt 模板**：
```
根據以下使用者滑雪問題的分析結果，判斷是否需要提出澄清問題以更好地幫助使用者：

使用者輸入：「{user_input}」
已識別症狀：{detected_symptoms}
已提供資訊：等級={level}, 地形={terrain}, 風格={style}
輸入文字長度：{input_length} 字

規則：
1. 若症狀置信度 < 0.7 或多個症狀競爭，應澄清症狀
2. 若缺少「等級」或「地形」，應詢問
3. 若輸入太短（< 10 字），應要求更多細節
4. 最多提出 2 個問題

請返回 JSON 格式：
{
  "need_followup": bool,
  "questions": [
    { "question": "...", "type": "level|terrain|style|clarification", "priority": 1 }
  ],
  "reasoning": "..."
}
```

**回傳格式**：
```json
{
  "need_followup": true,
  "questions": [
    {
      "question": "您目前的滑雪等級是？（初學/中級/高級）",
      "type": "level",
      "priority": 1
    },
    {
      "question": "您是指「重心過後」還是「身體往後倒」的感覺？",
      "type": "clarification",
      "priority": 2
    }
  ]
}
```

#### API-203.2: 追問問題生成機制

**問題來源優先級**：
1. **通用問題庫**（預定義，針對常見缺失）
   - 缺等級 → 「您目前的滑雪等級是？」
   - 缺地形 → 「您主要在什麼地形練習？」
   - 缺風格 → 「您是雙板還是單板？」

2. **LLM 動態生成**（更細緻的澄清）
   - 症狀競爭 → LLM 生成澄清問題
   - 描述不清 → LLM 生成詳細追問

---

## 4. 練習卡數量處理策略

**原則**：資料庫層不強制限制，服務層與 UI 層友善提示，管理後台驗證推薦。

### 層級職責分配

| 層級 | 職責 | 實現方式 |
|------|------|--------|
| **資料庫層** | 無限制 | 不強制 3-5 張外鍵約束，允許任意數量 |
| **API 服務層** | 選擇最佳匹配 | 根據關聯性分數排序，返回最高分的 3-5 張（不足則全部返回） |
| **前端 UI 層** | 友善提示 | 顯示「找到 X 張」或「已顯示前 5 張」提示訊息 |
| **管理後台** | 驗證推薦 | 新增/編輯症狀關聯時，檢查數量並提示但允許保存 |

### 具體實現

**API-202.2 (練習卡不足 3 張)**：
```json
{
  "practice_cards": [ { id: 1, ... }, { id: 2, ... } ],
  "warning": "找到 2 張練習卡，建議至少 3 張。若仍無其他合適練習卡，可嘗試調整篩選條件。",
  "count": { "found": 2, "recommended_min": 3, "recommended_max": 5 }
}
```

**API-202.3 (練習卡超過 5 張)**：
```json
{
  "practice_cards": [ { id: 1, ... }, ..., { id: 5, ... } ],
  "notice": "共找到 8 張練習卡，已顯示關聯性最高的前 5 張。",
  "count": { "found": 8, "displayed": 5, "recommended_max": 5 }
}
```

**API-205.3 (管理後台編輯症狀關聯)**：
```json
{
  "success": true,
  "warning": "該症狀目前關聯 6 張練習卡，建議調整至 3-5 張以優化使用者體驗。",
  "symptom": { id: 1, name: "...", ... },
  "practice_cards_count": 6,
  "allowed": true  // 允許保存，但加上警告
}
```

**UI-308.3 (症狀↔練習卡關聯管理)**：
```
症狀：「後坐」
已關聯練習卡：5 張
建議範圍：3-5 張 ✓
[新增] [刪除]
```

---

## 5. 使用者回饋設計更新

### 回饋方式改進

**原設計**（2 選項）：
- 👍 / 👎（簡單滿意度）

**新設計**（3 選項）：
- ❌ **不適用**（該練習卡與症狀無關或不適合）
- △ **部分適用**（有幫助但需調整）
- ✓ **適用**（完全符合需求）

**改進優點**：
1. **更精準的反饋**：從滿意度改為適用性評價，更能反映練習卡的實際效果
2. **更清晰的用途**：用戶可以明確表達練習卡是否有幫助
3. **更好的資料驅動優化**：可根據「部分適用」的反饋進行改進

**實作方式**：
- 三個大卡片/按鈕，顯示 Emoji + 文字標籤
- 用戶點擊選擇後高亮該選項
- 同時提供可選的自由文字回饋框（補充詳細意見）

**資料庫儲存**：
```sql
feedback_rating VARCHAR(20)
-- 值域：
-- "not_applicable" (❌ 不適用)
-- "partially_applicable" (△ 部分適用)
-- "applicable" (✓ 適用)
```

**API 回傳格式**：
```json
{
  "feedback_rating": "partially_applicable",
  "feedback_text": "這個練習很有用，但希望能有更詳細的步驟說明",
  "recorded_at": "2025-10-28T14:30:00Z"
}
```

---

## 6. 關鍵設計決策

### 6.1 簡化原則（Linus-Style）

✅ **已遵循**：
- 移除多代理架構，使用簡單函數
- 使用字典結構而非複雜 Pydantic 模型
- 聚焦核心問題，避免過度設計
- 保持向後兼容性

### 5.2 RAG 架構簡化

✅ **已確認**：
- 使用輕量級 ChromaDB（無需複雜管理）
- 使用開源模型 Sentence Transformers（無 API 依賴）
- 提示詞優化而非複雜提示工程
- LLM 輔助而非完全委託

### 5.3 前端架構

✅ **已確認**：
- React + TypeScript（豐富生態系）
- 組件化設計（便於維護和擴展）
- Tailwind CSS（快速開發）
- 深色主題支援（已在設計稿中體現）

### 5.4 部署策略

✅ **已確認**：
- Vercel（前端）+ Vercel Functions（後端）+ Supabase（資料庫）
- Serverless 架構（易於擴展）
- 按使用量計費（成本可控）

---

## 7. 下一步實作順序（含資料清洗工具）

根據 `plan.md` 的里程碑規劃，建議以下實作順序。**資料清洗工具（TOOL-101～107）與應用並行進行，這樣可以及早獲得知識庫資料進行測試**。

### 第 1 週：基礎架構 & 資料清洗工具 v1
**應用側**：
- **DB-101～106**：建立資料庫 schema（SQLite/Supabase）
- **DEV-601～609**：開發環境設定（Python、Node.js、Docker）

**工具側**：
- **TOOL-101**：逐字稿清洗 CLI（處理 .txt/.md 格式）
- **TOOL-102**：知識自動抽取（基於規則的症狀和練習提取）
- **TOOL-103**：資料驗證工具
- **TOOL-106.1～106.3**：CLI 初步命令（clean、extract、validate）

### 第 2 週：症狀辨識、RAG 核心、工具審核模組
**應用側**：
- **RAG-252.1～252.3**：ChromaDB 配置與初始化
- **RAG-253.1～253.3**：檢索機制實現
- **API-201**：症狀辨識 API
- **UI-300～UI-301**：首頁與輸入介面

**工具側**：
- **TOOL-104**：人工審核 Web UI（本地運行，http://localhost:8000）
- **TOOL-107.1～107.2**：應用知識庫管理 API（上傳、列表查詢）
- **TOOL-106.4**：CLI 導入命令（import）
- **執行初次清洗** → 產生 candidates_*.json → 人工審核 → 導入 ChromaDB

### 第 3 週：建議生成、追問、工具完善
**應用側**：
- **RAG-254.1～254.3**：提示詞組裝
- **RAG-255.1～255.4**：LLM 整合
- **API-202**：建議生成 API（含數量處理）
- **API-203**：自適應追問 API（LLM 輔助）
- **UI-302～UI-303**：追問與卡片展示介面

**工具側**：
- **TOOL-105**：知識庫導入工具完善（向量化、metadata 管理）
- **TOOL-107.3～107.4**：應用知識庫管理 API（審核操作、導出）
- **TOOL-106.5**：CLI 文件和使用範例

### 第 4 週：回饋、後台、測試、工具整合
**應用側**：
- **API-204**：使用者回饋 API
- **API-205**：管理後台 API（含練習卡數量驗證）
- **UI-304～UI-308**：卡片詳細、歷史、設定、後台頁面
- **UI-308.4**（應用內知識庫管理）：整合 TOOL-107 API

**工具側**：
- **文件整理**：README、範例資料、快速指南
- **自動化**：準備定期執行腳本（cron/scheduler）
- **與應用集成**：確保工具輸出能無縫銜接應用導入

**測試**：
- **TEST-401～TEST-405**：自動化測試（使用來自工具的真實知識庫資料）
- **End-to-End 測試**：從原始逐字稿 → 清洗 → 抽取 → 審核 → 導入 → 應用使用 → 回饋收集的完整流程

---

## 8. 文檔對應關係

| 文檔 | 主要內容 | 對應任務 |
|-----|--------|--------|
| `sdd-TurnFix.md` | 系統設計規格書 | 整體設計依據 |
| `spec/erm.dbml` | 資料模型定義 | DB 層任務 |
| `spec/features/*.feature` | Gherkin 功能規格 | 測試任務 |
| `tasks.md` | 詳細任務清單 | 開發實作 |
| `plan.md` | 週期性里程碑 | 進度管理 |
| `UI_Design_Brief.md` | UI 設計說明 | UI 層任務 |
| **`CLARIFICATION_SUMMARY.md`** | **本文檔** | **規劃釐清**📌 |

---

## 9. 待確認項目（如有）

目前所有核心規劃項目均已釐清。若在實作過程中遇到新的歧義，建議：

1. 更新本文檔的相應章節
2. 在 `tasks.md` 中標記為「已澄清」
3. 同時更新相關設計文檔

---

**文檔版本**：v1.0
**更新日期**：2025-10-28
**釐清項目數**：4 項（UI 頁面、RAG 流程、追問邏輯、練習卡數量）
**狀態**：✅ 已完成，可開始實作
