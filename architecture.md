# TurnFix 系統架構圖

## 六邊形架構 (端口與適配器模式)

```
┌─────────────────────────────────────┐
│            外部介面層                 │
│   (API接口 / UI / CLI)              │
├─────────────────────────────────────┤
│            介面適配器層              │
│   (Controller / API Handler)        │
├─────────────────────────────────────┤
│            核心應用層                 │
│   (Use Cases / Application Logic)   │
├─────────────────────────────────────┤
│            領域模型層                 │
│   (Entities / Domain Logic)         │
├─────────────────────────────────────┤
│            基礎設施層                 │
│   (DB / External Services / Cache)  │
└─────────────────────────────────────┘
```

## 技術組件圖

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (React + TypeScript)                │
├─────────────────────────────────────────────────────────────────┤
│  UI Components → State Management → API Clients                 │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                        後端 (FastAPI)                           │
├─────────────────────────────────────────────────────────────────┤
│  API Routes → Service Functions → RAG/LLM Integration           │
│  (簡化實現)      (簡單函數)      (RAG + Generation)              │
│                                │                                │
│                                ▼                                │
│                    ┌─────────────────────────┐                  │
│                    │   AI/LLM Layer          │                  │
│                    │  (RAG + Generation)     │                  │
│                    └─────────────────────────┘                  │
└─────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
        ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
        │   SQLite DB     │ │ Chroma Vector   │ │ External APIs   │
        │   (ORM:         │ │ DB              │ │ (LLM, etc)      │
        │   SQLAlchemy)   │ │ (Embeddings)    │ │                 │
        └─────────────────┘ └─────────────────┘ └─────────────────┘
```

## AI 模型優化層

┌─────────────────────────────────────────────────────────────────┐
│                    AI 模型優化策略                              │
├─────────────────────────────────────────────────────────────────┤
│  • 模型量化 (Quantization)                                      │
│  • 預載模型到記憶體 (Model Caching)                             │
│  • 預計算向量 (Pre-computed Embeddings)                         │
│  • 同義詞庫優化 (Synonym Optimization)                          │
└─────────────────────────────────────────────────────────────────┘

## 安全層

┌─────────────────────────────────────────────────────────────────┐
│                        安全措施                                 │
├─────────────────────────────────────────────────────────────────┤
│  • 輸入驗證與清理 (Input Validation & Sanitization)             │
│  • API 速率限制 (Rate Limiting)                                 │
│  • 資料加密 (Data Encryption)                                   │
│  • 提示詞注入防護 (Prompt Injection Protection)                 │
│  • 內容過濾 (Content Filtering)                                 │
└─────────────────────────────────────────────────────────────────┘

## 分析與回饋系統層

┌─────────────────────────────────────────────────────────────────┐
│                      分析與回饋系統                             │
├─────────────────────────────────────────────────────────────────┤
│  • 使用者行為分析 (User Behavior Analytics)                     │
│  • 系統效能監控 (System Performance Monitoring)                 │
│  • 回饋收集與分析 (Feedback Collection & Analysis)              │
│  • 資料追蹤 (Data Tracking)                                     │
│  • 指標監控 (Metrics Monitoring)                                │
└─────────────────────────────────────────────────────────────────┘

## 維護與營運層

┌─────────────────────────────────────────────────────────────────┐
│                        維護與營運                               │
├─────────────────────────────────────────────────────────────────┤
│  • CI/CD 流程 (CI/CD Pipeline)                                  │
│  • 自動化測試 (Automated Testing)                               │
│  • 版本控制 (Version Control)                                   │
│  • 系統維護 (System Maintenance)                                │
│  • 回歸測試 (Regression Testing)                                │
└─────────────────────────────────────────────────────────────────┘

## 使用者體驗優化層

┌─────────────────────────────────────────────────────────────────┐
│                      使用者體驗優化                             │
├─────────────────────────────────────────────────────────────────┤
│  • 回應式設計 (Responsive Design)                               │
│  • 智慧提示 (Smart Suggestions)                                 │
│  • 效能優化 (Performance Optimization)                          │
│  • 快取機制 (Caching Mechanisms)                                │
│  • 非同步處理 (Asynchronous Processing)                         │
│  • 錯誤處理與進度指示 (Error Handling & Progress Indicators)    │
└─────────────────────────────────────────────────────────────────┘

## 錯誤處理與彈性設計層

┌─────────────────────────────────────────────────────────────────┐
│                    錯誤處理與彈性設計                           │
├─────────────────────────────────────────────────────────────────┤
│  • 熔斷器模式 (Circuit Breaker Pattern)                         │
│  • 重試機制 (Retry Mechanism)                                   │
│  • 降級策略 (Fallback Strategies)                               │
│  • 錯誤恢復 (Error Recovery)                                    │
│  • 監控與告警 (Monitoring & Alerting)                           │
│  • 資源隔離 (Resource Isolation)                                │
└─────────────────────────────────────────────────────────────────┘

## 資料處理層

┌─────────────────────────────────────────────────────────────────┐
│                      資料管理策略                               │
├─────────────────────────────────────────────────────────────────┤
│  • 影片逐字稿處理 (Video Transcript Processing)                 │
│  • 症狀-練習對應建立 (Symptom-Practice Mapping)                 │
│  • 結構化資料生成 (Structured Data Generation)                 │
│  • 知識庫維護 (Knowledge Base Maintenance)                      │
│  • 自動化流程 (Automation Pipeline)                             │
│  • 品質控制 (Quality Control)                                   │
└─────────────────────────────────────────────────────────────────┘

## 測試層

┌─────────────────────────────────────────────────────────────────┐
│                        測試策略                                 │
├─────────────────────────────────────────────────────────────────┤
│  • 單元測試 (Unit Tests)                                        │
│  • 整合測試 (Integration Tests)                                 │
│  • 端到端測試 (E2E Tests)                                       │
│  • 效能測試 (Performance Tests)                                 │
│  • AI 模型準確性測試 (AI Model Accuracy Tests)                  │
│  • 安全測試 (Security Tests)                                    │
└─────────────────────────────────────────────────────────────────┘

## 檔案結構

```
turnfix/
├── app/
│   ├── __init__.py
│   ├── main.py                 # 應用程序入口
│   ├── api/
│   │   ├── __init__.py
│   │   ├── v1/
│   │   │   ├── __init__.py
│   │   │   ├── api.py          # API 定義
│   │   │   └── endpoints/
│   │   │       ├── __init__.py
│   │   │       ├── symptoms.py
││   │   │       ├── practice_cards.py
│   │   │       └── sessions.py
│   ├── core/
│   │   ├── __init__.py
│   │   ├── config.py          # 配置管理
│   │   ├── security.py        # 安全相關
│   │   └── database.py        # 資料庫配置
│   ├── models/
│   │   ├── __init__.py
│   │   ├── symptom.py         # 領域模型
│   │   ├── practice_card.py   # 領域模型
│   │   ├── session.py         # 領域模型
│   │   └── mapping.py         # 領域模型
│   ├── services/
│   │   ├── __init__.py
│   │   ├── symptom_service.py # 應用服務
│   │   ├── practice_service.py
│   │   └── rag_service.py     # RAG 相關服務
│   ├── database/
│   │   ├── __init__.py
│   │   ├── base.py           # 資料庫基類
│   │   ├── models.py         # ORM 模型
│   │   └── repositories.py   # 資料庫存取
│   └── utils/
│       ├── __init__.py
│       ├── validation.py     # 驗證工具
│       └── helpers.py        # 輔助函數
├── tests/
│   ├── __init__.py
│   ├── conftest.py          # 測試配置
│   ├── test_symptoms.py     # 單元測試
│   └── test_api.py          # 整合測試
├── requirements.txt         # 依賴列表
├── alembic/                # 資料庫遷移工具
│   └── versions/           # 遷移腳本
└── docker-compose.yml       # 容器配置
```

## 部署架構

### Serverless 部署 (Vercel + Supabase)

```
┌─────────────────────────────────────────────────────────────────┐
│                        Client (Browser)                         │
├─────────────────────────────────────────────────────────────────┤
│                    React Frontend (Vercel)                      │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Serverless Functions (Vercel)                 │
├─────────────────────────────────────────────────────────────────┤
│  FastAPI → Service Layer → Domain Models → Data Access Layer   │
│  (簡化實現)      (簡單函數)      (字典結構)      (ORM)           │
│                                │                                │
│                                ▼                                │
│                    ┌─────────────────────────┐                  │
│                    │   AI/LLM Layer          │                  │
│                    │  (RAG + Generation)     │                  │
│                    └─────────────────────────┘                  │
└─────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
        ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
        │ Supabase DB     │ │ Chroma Vector   │ │ External APIs   │
        │ (PostgreSQL)    │ │ DB              │ │ (LLM, etc)      │
        └─────────────────┘ └─────────────────┘ └─────────────────┘
```

## 擴展路徑

當系統需要擴展時，可以按以下方式進行：

### Serverless 限制處理
- 當 AI 計算時間超過 Serverless 函數限制時，可採用非同步處理：
  - 使用消息隊列 (如 AWS SQS) 處理長時間 AI 任務
  - 透過 WebSocket 或輪詢機制回傳結果

### 資料庫擴展
- SQLite → Supabase (PostgreSQL)
- 使用相同的 SQLAlchemy ORM 層，只需更改配置

### 向量資料庫擴展
- ChromaDB → Weaviate/Pinecone
- 通過抽象層替換實作

### 後端擴展
- Serverless Functions → 專用伺服器實例
- 單體應用 → 微服務架構
- 加入消息隊列和快取層

### 前端擴展
- 單頁應用 → 服務端渲染
- 加入更複雜的狀態管理